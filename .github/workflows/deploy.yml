name: pick-team github CI-CD

on:
  push:
    branches:
      - main       # main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
      - production # production ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‘ì—… ì‹¤í–‰

    env:
      GITHUB_REF_NAME: ${{ github.ref_name }} # ì´ë²¤íŠ¸ê°€ ì¼ì–´ë‚œ ë¸Œëœì¹˜ ì´ë¦„ ì½ì–´ì˜¤ê¸°

    steps:
      - name: Checkout source
        uses: actions/checkout@v3  # GitHub ì €ì¥ì†Œì˜ ì†ŒìŠ¤ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì•¡ì…˜

      - name: Set up JDK 17
        uses: actions/setup-java@v3  # JDK ì„¤ì • ì•¡ì…˜
        with:
          java-version: '17'        # Java 17 ë²„ì „ ì‚¬ìš©
          distribution: 'temurin'   # AdoptOpenJDKì˜ Temurin ë°°í¬íŒ ì‚¬ìš©

      - name: ë¸Œëœì¹˜ í™˜ê²½ ë¡œê·¸ í™•ì¸
        run: |
          echo "í˜„ì¬ ë¸Œëœì¹˜"
          echo "${GITHUB_REF_NAME}"

      - name: Spring í™˜ê²½ë³€ìˆ˜ ì£¼ì… (.env ìƒì„±) # .env íŒŒì¼ì˜ ë‚´ìš©ì„ secretìœ¼ë¡œë¶€í„° ì½ì–´ë‹¤ í†µì§¸ë¡œ ì£¼ì…
        run: |
          if [ "${GITHUB_REF_NAME}" == "main" ]; then
            echo "${{ secrets.ENV_DEV }}" > .env  # main ë¸Œëœì¹˜ì¼ ê²½ìš° DEV í™˜ê²½ë³€ìˆ˜ ì ìš©
            echo "EC2_HOST=${{ secrets.EC2_HOST_DEV }}" >> $GITHUB_ENV
          elif [ "${GITHUB_REF_NAME}" == "production" ]; then
            echo "${{ secrets.ENV_PROD }}" > .env # production ë¸Œëœì¹˜ì¼ ê²½ìš° PROD í™˜ê²½ë³€ìˆ˜ ì ìš©
            echo "EC2_HOST=${{ secrets.ES2_HOST_PROD }}" >> $GITHUB_ENV
          else
            echo "ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œëœì¹˜ì…ë‹ˆë‹¤. ì¢…ë£Œí•©ë‹ˆë‹¤." # ì˜ˆì™¸ì²˜ë¦¬
            exit 1
          fi
          echo "SSH_PORT=${{ secrets.SSH_PORT }}" >> $GITHUB_ENV

      - name: ìë™ ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì • (ë¸Œëœì¹˜ëª… + ë‚ ì§œ + SHA)
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TODAY=$(date +%Y%m%d)
          IMAGE_TAG="${GITHUB_REF_NAME}-$TODAY-$SHORT_SHA"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> .env
          echo "GITHUB_REF_NAME=$GITHUB_REF_NAME" >> .env
          echo "BUILD_TIME=$TODAY" >> .env

      - name: mvnw ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./mvnw  # mvnw íŒŒì¼(Wrapper)ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬

      - name: Maven ë¹Œë“œ ì‹¤í–‰
        run: ./mvnw clean package -DskipTests  # Maven ë¹Œë“œ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ ìƒëµ)
      # run: ./mvnw clean verify  # í…ŒìŠ¤íŠ¸ í¬í•¨ ë¹Œë“œ ì‹œ ì´ ëª…ë ¹ì–´ ì‚¬ìš©

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3  # Docker Hubì— ë¡œê·¸ì¸í•˜ëŠ” ì•¡ì…˜
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/kosta-pick-team:${{ env.IMAGE_TAG }} .  # ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë„ì»¤ ì´ë¯¸ì§€ë¡œ ë¹Œë“œ

      - name: Docker ì´ë¯¸ì§€ í‘¸ì‹œ
        run: docker push ${{ secrets.DOCKER_USERNAME }}/kosta-pick-team:${{ env.IMAGE_TAG }}   # ë¹Œë“œí•œ ì´ë¯¸ì§€ë¥¼ Docker Hubì— ì—…ë¡œë“œ

      # EC2 -> ì˜¨í”„ë ˆë¯¸ìŠ¤ë¡œ ë³€ê²½ (ê¸°ë³¸ì ì¸ ì„¸íŒ… ë™ì¼í•˜ë¯€ë¡œ í™˜ê²½ë³€ìˆ˜ëª…ì— ì‚¬ìš©í•˜ëŠ” ì ‘ë‘ì–´ EC2 ìœ ì§€)
      - name: ë°°í¬ì„œë²„ì— docker-compose.yml + .env ì „ì†¡
        uses: appleboy/scp-action@v0.1.7  # ë°°í¬ì„œë²„ë¡œ íŒŒì¼ ì „ì†¡í•˜ëŠ” ì•¡ì…˜(SCP)
        with:
          host: ${{ env.EC2_HOST }}            # ë°°í¬ì„œë²„ í˜¸ìŠ¤íŠ¸ ì£¼ì†Œ
          port: ${{ env.SSH_PORT }}             # SSH í¬íŠ¸ë²ˆí˜¸ (ì˜¨í”„ë ˆë¯¸ìŠ¤ëŠ” ì»¤ìŠ¤í…€ í¬íŠ¸ë²ˆí˜¸ ì‚¬ìš©)
          username: ${{ secrets.EC2_USERNAME }} # ë°°í¬ì„œë²„ ì‚¬ìš©ìëª…
          key: ${{ secrets.EC2_PRIVATE_KEY }}   # ë°°í¬ì„œë²„ ê°œì¸ í‚¤
          source: "docker-compose.yml,.env"     # ì „ì†¡í•  íŒŒì¼ ëª©ë¡
          target: ${{ secrets.DOCKER_DEPLOY_DIRECTORY }}  # ë°°í¬ì„œë²„ ë‚´ ëŒ€ìƒ ê²½ë¡œ

      - name: EC2ì—ì„œ docker-compose ì‹¤í–‰ (ê²½ë¡œ ìë™íƒì§€ & Stopâ†’Recreate + Nginx ì¬ê¸°ë™)
        uses: appleboy/ssh-action@v1.0.0  # ë°°í¬ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ëª…ë ¹ ì‹¤í–‰
        with:
          host: ${{ env.EC2_HOST }} # ë°°í¬ì„œë²„ í˜¸ìŠ¤íŠ¸ ì£¼ì†Œ
          port: ${{ env.SSH_PORT }} # SSH í¬íŠ¸ë²ˆí˜¸ (ì˜¨í”„ë ˆë¯¸ìŠ¤ëŠ” ì»¤ìŠ¤í…€ í¬íŠ¸ë²ˆí˜¸ ì‚¬ìš©)
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            set -eu
            # Synology ìì£¼ ì“°ëŠ” ê²½ë¡œê¹Œì§€ PATH í™•ì¥
            export PATH="/usr/local/bin:/usr/bin:/bin:/sbin:/usr/sbin:/opt/bin:/opt/sbin:/var/packages/Docker/target/usr/bin:$PATH"

            DEPLOY_DIR="${{ secrets.DOCKER_DEPLOY_DIRECTORY }}"  # ë„ì»¤ íŒŒì¼ì´ ìœ„ì¹˜í•œ ê²½ë¡œ
            NGINX_DIR="${{ secrets.DOCKER_NGINX_DIRECTORY }}"    # ì™¸ë¶€ Nginx compose ë””ë ‰í† ë¦¬ (ìˆìœ¼ë©´ ì¬ê¸°ë™)
            IMAGE="${{ secrets.DOCKER_USERNAME }}/kosta-pick-team:${{ env.IMAGE_TAG }}"  # ìµœì‹  ì´ë¯¸ì§€ íƒœê·¸
            SERVICE="kosta-pick-team-backend"  # ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì´ë¦„ (composeì˜ ì„œë¹„ìŠ¤ í‚¤ì™€ ì¼ì¹˜)

            # docker-compose v1 ê²½ë¡œ íƒì§€ (ì—†ìœ¼ë©´ v2 fallback)
            COMPOSE_IS_V2=0
            if command -v docker-compose >/dev/null 2>&1; then
              COMPOSE_V1="$(command -v docker-compose)"
            else
              for p in /var/packages/Docker/target/usr/bin/docker-compose /usr/local/bin/docker-compose /usr/bin/docker-compose /bin/docker-compose; do
                [ -x "$p" ] && COMPOSE_V1="$p" && break
              done
            fi
            if [ -z "${COMPOSE_V1:-}" ]; then
              if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
                COMPOSE_IS_V2=1
              else
                echo "âŒ docker-compose(v1)/docker compose(v2) ì—†ìŒ"
                exit 1
              fi
            fi
            compose() { if [ "$COMPOSE_IS_V2" -eq 1 ]; then docker compose "$@"; else "$COMPOSE_V1" "$@"; fi; }
            echo "âœ… compose ì‚¬ìš©: $([ "$COMPOSE_IS_V2" -eq 1 ] && echo 'v2(docker compose)' || echo "v1($COMPOSE_V1)")"

            cd "$DEPLOY_DIR"  # ë„ì»¤ íŒŒì¼ì´ ìœ„ì¹˜í•œ ê²½ë¡œë¡œ ì´ë™

            # 0) ìƒˆ ì´ë¯¸ì§€ ë¯¸ë¦¬ ë‹¹ê²¨ë†“ê¸° (ì‹¤íŒ¨í•´ë„ ê³„ì†)
            docker pull "$IMAGE" || true

            # 1) ì„œë¹„ìŠ¤ë§Œ ì•ˆì „í•˜ê²Œ ì¤‘ì§€ (ì‹¤í–‰ ì¤‘ ì•„ë‹ˆì–´ë„ ì—ëŸ¬ ì—†ì´ í†µê³¼)
            compose -f docker-compose.yml stop "$SERVICE" || true

            # 2) ì»¨í…Œì´ë„ˆ ì œê±° (ë³¼ë¥¨ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
            compose -f docker-compose.yml rm -f "$SERVICE" || true

            # 3) ì‹ ê·œ ì»¨í…Œì´ë„ˆ ê¸°ë™ (ì—°ê´€ ì„œë¹„ìŠ¤ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
            compose -f docker-compose.yml up -d --no-deps --force-recreate "$SERVICE"

            # 4) (ì˜µì…˜) í—¬ìŠ¤ì²´í¬ê°€ ì •ì˜ë¼ ìˆìœ¼ë©´ 'healthy' ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            if docker inspect "$SERVICE" >/dev/null 2>&1; then
              echo "â³ waiting for $SERVICE to be healthy..."
              for i in $(seq 1 60); do
                STATUS="$(docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{else}}unknown{{end}}' "$SERVICE")" || true
                if [ "$STATUS" = "healthy" ]; then
                  echo "âœ… $SERVICE healthy"
                  break
                fi
                sleep 2
              done
            fi

            # 5) ì´ë¯¸ì§€ ì •ë¦¬ (ë””ìŠ¤í¬ ì••ë°• ë°©ì§€)
            docker image prune -f || true

            # 6) ì™¸ë¶€ Nginx ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ (Upstream ë¦¬í”„ë ˆì‹œ/ë¼ìš°íŒ… ìƒˆë¡œê³ ì¹¨)
            if [ -n "$NGINX_DIR" ] && [ -d "$NGINX_DIR" ]; then
              cd "$NGINX_DIR"
              # compose ë°”ì´ë„ˆë¦¬ ë™ì¼ ë¡œì§ìœ¼ë¡œ ì‹¤í–‰
              compose -f docker-compose.yml restart || true
            fi

            echo "ğŸ‰ Deploy done (Stopâ†’Recreate + nginx restart)."
